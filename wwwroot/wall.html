<!DOCTYPE html>
<html>
<head>
    <title>Fingerprint Thumbnail Test</title>
    <style>
        body {
            background: #1a1a2e;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }

        canvas {
            border: 1px solid #333;
            image-rendering: pixelated;
        }

        .scaled {
            width: 360px;
            height: 300px;
        }
    </style>
    <link rel="stylesheet" href="styles/index.css">
</head>
<body>
    <h1>Fingerprint Thumbnail Test</h1>
    <input type="text" id="appId" placeholder="App ID" value="570">
    <button onclick="load()">Load</button>
    <br><br>
    <canvas id="thumb" width="120" height="100"></canvas>
    <canvas id="thumbScaled" width="120" height="100" class="scaled"></canvas>

    <script>
        // Read colors from CSS variables
        function getCssColor(varName) {
            const hex = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            // Convert hex to RGB array
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return [r, g, b];
        }

        const posColor = getCssColor('--color-positive');
        const negColor = getCssColor('--color-negative');
        const uncColor = getCssColor('--color-uncertain');

        async function load() {
            const appId = document.getElementById('appId').value;
            const res = await fetch(`/fingerprint/${appId}`);
            if (!res.ok) { alert('Not found'); return; }

            const data = await res.json();
            const rgba = Uint8Array.from(atob(data.thumbnailPng), c => c.charCodeAt(0));

            renderMask(rgba, 'thumb');
            renderMask(rgba, 'thumbScaled');
        }

        function renderMask(rgba, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const img = ctx.createImageData(120, 100);

            for (let i = 0; i < 120 * 100; i++) {
                const r = rgba[i * 4];
                const g = rgba[i * 4 + 1];
                const b = rgba[i * 4 + 2];
                const a = rgba[i * 4 + 3];

                if (r > 0 || g > 0 || b > 0) {
                    // Has data - pick dominant channel's color
                    if (r >= g && r >= b) {
                        img.data[i * 4] = posColor[0];
                        img.data[i * 4 + 1] = posColor[1];
                        img.data[i * 4 + 2] = posColor[2];
                    } else if (g >= r && g >= b) {
                        img.data[i * 4] = negColor[0];
                        img.data[i * 4 + 1] = negColor[1];
                        img.data[i * 4 + 2] = negColor[2];
                    } else {
                        img.data[i * 4] = uncColor[0];
                        img.data[i * 4 + 1] = uncColor[1];
                        img.data[i * 4 + 2] = uncColor[2];
                    }
                    img.data[i * 4 + 3] = 255;  // solid
                } else {
                    // Empty
                    img.data[i * 4 + 3] = 0;
                }
            }

            ctx.putImageData(img, 0, 0);
        }
    </script>
</body>
</html>
